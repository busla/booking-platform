{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "openapi-output.schema.json",
  "title": "OpenAPI Output Schema",
  "description": "JSON Schema for the OpenAPI specification generated by generate_openapi.py with AWS API Gateway extensions",
  "type": "object",
  "required": ["openapi", "info", "paths", "components", "x-amazon-apigateway-cors"],
  "properties": {
    "openapi": {
      "type": "string",
      "pattern": "^3\\.0\\.[0-9]+$",
      "description": "OpenAPI version (3.0.x)"
    },
    "info": {
      "type": "object",
      "required": ["title", "version"],
      "properties": {
        "title": {
          "type": "string",
          "description": "API title from FastAPI app"
        },
        "version": {
          "type": "string",
          "description": "API version from FastAPI app"
        },
        "description": {
          "type": "string",
          "description": "API description from FastAPI app"
        }
      }
    },
    "x-amazon-apigateway-cors": {
      "$ref": "#/$defs/CORSConfiguration"
    },
    "components": {
      "type": "object",
      "required": ["securitySchemes"],
      "properties": {
        "securitySchemes": {
          "type": "object",
          "required": ["cognito-jwt"],
          "properties": {
            "cognito-jwt": {
              "$ref": "#/$defs/CognitoJWTScheme"
            }
          }
        },
        "schemas": {
          "type": "object",
          "description": "Pydantic model schemas from FastAPI",
          "additionalProperties": true
        }
      }
    },
    "paths": {
      "type": "object",
      "description": "API paths with AWS integrations",
      "additionalProperties": {
        "$ref": "#/$defs/PathItem"
      }
    }
  },
  "$defs": {
    "CORSConfiguration": {
      "type": "object",
      "description": "x-amazon-apigateway-cors configuration",
      "required": ["allowOrigins", "allowMethods", "allowHeaders"],
      "properties": {
        "allowOrigins": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Allowed origins (e.g., ['https://example.com', '*'])"
        },
        "allowMethods": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Allowed HTTP methods (e.g., ['GET', 'POST', 'OPTIONS'])"
        },
        "allowHeaders": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Allowed request headers"
        },
        "exposeHeaders": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Headers exposed to browser"
        },
        "maxAge": {
          "type": "integer",
          "description": "Preflight cache duration in seconds"
        },
        "allowCredentials": {
          "type": "boolean",
          "description": "Whether credentials are supported"
        }
      }
    },
    "CognitoJWTScheme": {
      "type": "object",
      "description": "OAuth2 security scheme with JWT authorizer",
      "required": ["type", "x-amazon-apigateway-authorizer"],
      "properties": {
        "type": {
          "type": "string",
          "const": "oauth2"
        },
        "flows": {
          "type": "object",
          "description": "OAuth2 flows (empty for JWT authorizer)"
        },
        "x-amazon-apigateway-authorizer": {
          "$ref": "#/$defs/JWTAuthorizer"
        }
      }
    },
    "JWTAuthorizer": {
      "type": "object",
      "description": "x-amazon-apigateway-authorizer for JWT",
      "required": ["type", "identitySource", "jwtConfiguration"],
      "properties": {
        "type": {
          "type": "string",
          "const": "jwt"
        },
        "identitySource": {
          "type": "string",
          "default": "$request.header.Authorization",
          "description": "Where to find the JWT token"
        },
        "jwtConfiguration": {
          "type": "object",
          "required": ["issuer", "audience"],
          "properties": {
            "issuer": {
              "type": "string",
              "pattern": "^https://cognito-idp\\.[a-z]+-[a-z]+-[0-9]+\\.amazonaws\\.com/[a-z]+-[a-z]+-[0-9]+_[A-Za-z0-9]+$",
              "description": "Cognito issuer URL"
            },
            "audience": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 1,
              "description": "Cognito app client IDs"
            }
          }
        }
      }
    },
    "PathItem": {
      "type": "object",
      "description": "OpenAPI path item with operations",
      "additionalProperties": {
        "$ref": "#/$defs/Operation"
      }
    },
    "Operation": {
      "type": "object",
      "description": "OpenAPI operation with AWS integration",
      "required": ["x-amazon-apigateway-integration"],
      "properties": {
        "summary": { "type": "string" },
        "description": { "type": "string" },
        "operationId": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        },
        "security": {
          "type": "array",
          "description": "Security requirements (empty array for public routes)",
          "items": {
            "type": "object",
            "additionalProperties": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "parameters": {
          "type": "array",
          "items": { "$ref": "#/$defs/Parameter" }
        },
        "requestBody": {
          "type": "object",
          "description": "Request body schema"
        },
        "responses": {
          "type": "object",
          "description": "Response schemas"
        },
        "x-amazon-apigateway-integration": {
          "$ref": "#/$defs/LambdaProxyIntegration"
        }
      }
    },
    "Parameter": {
      "type": "object",
      "required": ["name", "in"],
      "properties": {
        "name": { "type": "string" },
        "in": {
          "type": "string",
          "enum": ["path", "query", "header", "cookie"]
        },
        "required": { "type": "boolean" },
        "schema": { "type": "object" },
        "description": { "type": "string" }
      }
    },
    "LambdaProxyIntegration": {
      "type": "object",
      "description": "x-amazon-apigateway-integration for Lambda proxy",
      "required": ["type", "httpMethod", "uri", "payloadFormatVersion"],
      "properties": {
        "type": {
          "type": "string",
          "const": "AWS_PROXY"
        },
        "httpMethod": {
          "type": "string",
          "const": "POST"
        },
        "uri": {
          "type": "string",
          "pattern": "^arn:aws:apigateway:[a-z]+-[a-z]+-[0-9]+:lambda:path/2015-03-31/functions/arn:aws:lambda:[a-z]+-[a-z]+-[0-9]+:[0-9]+:function:[a-zA-Z0-9_-]+/invocations$",
          "description": "Lambda invocation URI"
        },
        "payloadFormatVersion": {
          "type": "string",
          "const": "2.0"
        }
      }
    }
  }
}
